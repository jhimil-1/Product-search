<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI E-commerce Chatbot</title>
  <link rel="stylesheet" href="/static/css/styles.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 800px; margin: 0 auto; }
    .step { 
      border: 1px solid #ddd; 
      padding: 15px; 
      margin-bottom: 20px;
      border-radius: 5px;
    }
    
    /* Drop area styles */
    #drop-area {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin: 20px 0;
      transition: all 0.3s;
    }
    
    #drop-area.highlight {
      background-color: #f0f8ff;
      border-color: #4CAF50;
    }
    
    /* Loading spinner */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Products grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .product-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .product-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    
    .no-image-placeholder {
      width: 100%;
      height: 200px;
      background-color: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
    }
    
    .product-info {
      padding: 15px;
    }
    
    .product-name {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    
    .product-price {
      font-size: 18px;
      color: #e44d26;
      margin: 0 0 10px 0;
    }
    
    .product-description {
      font-size: 14px;
      color: #666;
      margin: 0 0 10px 0;
    }
    
    .product-meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #888;
    }
    
    .loading-message, .error-message {
      text-align: center;
      padding: 30px;
    }
    .step-header { 
      font-weight: bold; 
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .step-content { display: none; }
    .step.active .step-content { display: block; }
    .step.complete { border-color: #4CAF50; }
    .step-number {
      background: #4CAF50;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }
    #chat { 
      border: 1px solid #ccc; 
      padding: 15px; 
      height: 400px; 
      overflow-y: auto; 
      margin: 20px 0;
    }
    .message { margin: 10px 0; padding: 8px 12px; border-radius: 5px; max-width: 80%; }
    .user { 
      background-color: #e3f2fd; 
      margin-left: auto; 
      margin-right: 0;
      text-align: right;
    }
    .bot { 
      background-color: #f1f1f1; 
      margin-right: auto;
    }
    .product { 
      border: 1px solid #ddd; 
      margin: 5px; 
      padding: 10px; 
      display: inline-block; 
      width: 180px; 
      text-align: center; 
      vertical-align: top;
      border-radius: 5px;
    }
    .product img { 
      width: 150px; 
      height: 150px; 
      object-fit: cover;
      border-radius: 4px;
    }
    .product-title {
      font-weight: bold;
      margin: 5px 0;
    }
    .product-price {
      color: #e53935;
      font-weight: bold;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    textarea, input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .hidden { display: none; }
    .user-info {
      text-align: right;
      padding: 10px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
    }
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 10px;
    }
    .logout-btn:hover {
      background: #d32f2f;
    }
    .search-results {
      margin-top: 10px;
    }
    .product-result {
      display: flex;
      margin-bottom: 10px;
    }
    .product-image {
      width: 100px;
      height: 100px;
      margin-right: 10px;
    }
    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .product-details {
      flex-grow: 1;
    }
    .product-details h4 {
      margin-top: 0;
    }
    .price {
      font-weight: bold;
      color: #e53935;
    }
    .description {
      margin-bottom: 10px;
    }
    .category {
      color: #666;
    }
    .similarity {
      color: #666;
    }
  </style>
  <script src="/js/main.js"></script>
  <script>
    // Global variables
    let sessionId = "";
    let currentStep = 1;
  </script>
</head>
<body>
  <div class="user-info" id="userInfo" style="display: none;">
    Welcome, <span id="userName"></span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <h1>AI E-commerce Assistant</h1>
  
  <!-- Step 1: Create Session -->
  <div class="step" id="step1">
    <div class="step-header">
      <div><span class="step-number">1</span> Start a New Session</div>
      <span id="sessionStatus">Not started</span>
    </div>
    <div class="step-content">
      <p>Click the button below to start a new shopping session.</p>
      <button id="createSession">Create New Session</button>
      <div id="sessionId" class="hidden"></div>
    </div>
  </div>

  <!-- Step 2: Upload Products -->
  <div class="step" id="step2">
    <div class="step-header">
      <div><span class="step-number">2</span> Upload Product Catalog</div>
    </div>
    <div class="step-content">
      <p>Upload your product catalog in JSON format:</p>
      <textarea id="productsJson" rows="6" placeholder='[
  {
    "product_id": "1",
    "name": "Gold Necklace",
    "category": "Jewelry",
    "price": "499.99",
    "description": "Elegant gold necklace with 18K gold."
  },
  {
    "product_id": "2",
    "name": "Silver Ring",
    "category": "Jewelry",
    "price": "199.99",
    "description": "Beautiful sterling silver ring with cubic zirconia."
  }
]'></textarea>
      <p>Upload product images (make sure the order matches the JSON):</p>
      <input type="file" id="productImages" multiple accept="image/*">
      <button id="uploadProducts" disabled>Upload Products</button>
      <div id="uploadStatus"></div>
    </div>
  </div>

  <!-- Step 3: Search and Chat -->
  <div class="step" id="step3">
    <div class="step-header">
      <div><span class="step-number">3</span> Search & Ask Questions</div>
    </div>
    <div class="step">
      <div class="step-header">Step 3: Upload Image</div>
      <div id="drop-area">
        <p>Drag & drop an image here, or click to select</p>
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
        <div id="imagePreview"></div>
      </div>
      <div id="results-container"></div>
    </div>
    <div id="chat"></div>
    <div style="margin-top: 20px;">
      <div style="display: flex; align-items: center; margin-bottom: 10px;">
        <button id="browseImage">Upload Image to Search</button>
        <input type="file" id="imageQuery" accept="image/*" style="display: none;">
        <span id="selectedImage" style="margin-left: 10px;">No image selected</span>
      </div>
    <div style="display: flex; margin-top: 10px;">
      <input type="text" id="textQuery" placeholder="Ask a question about the products..." style="flex-grow: 1;">
      <button id="sendQuery">Send</button>
    </div>
  </div>

  <script>
    // Initialize steps
    function updateSteps() {
      document.querySelectorAll('.step').forEach((step, index) => {
        if (index + 1 < currentStep) {
          step.classList.add('complete');
          step.classList.remove('active');
        } else if (index + 1 === currentStep) {
          step.classList.add('active');
          step.classList.remove('complete');
        } else {
          step.classList.remove('active', 'complete');
        }
      });
    }

    // Format price
    function formatPrice(price) {
      if (!price) return '';
      return `$${parseFloat(price).toFixed(2)}`;
    }

    // Add message to chat
    function addMessage(sender, content, isProduct = false, id = null) {
      const chat = document.getElementById('chat');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      if (id) {
        messageDiv.id = id;
      }
      
      if (isProduct) {
        if (typeof content === 'string') {
          messageDiv.textContent = content;
        } else {
          // Handle product object
          const product = content;
          // Handle image path
          let imageUrl = product.image_url || '';
          if (imageUrl && !imageUrl.startsWith('http') && !imageUrl.startsWith('/') && !imageUrl.startsWith('data:')) {
            imageUrl = `/${imageUrl}`;
          }
          
          messageDiv.innerHTML = `
            <div class="product-result">
              <div class="product-image">
                ${imageUrl ? `<img src="${imageUrl}" alt="${product.name}" onerror="this.style.display='none';">` : ''}
              </div>
              <div class="product-details">
                <h4>${product.name || 'Unnamed Product'}</h4>
                ${product.price ? `<p class="price">$${parseFloat(product.price).toFixed(2)}</p>` : ''}
                ${product.description ? `<p class="description">${product.description}</p>` : ''}
                ${product.category ? `<p class="category">Category: ${product.category}</p>` : ''}
                ${product.score ? `<p class="similarity">Similarity: ${product.score}%</p>` : ''}
              </div>
            </div>
          `;
        }
      } else {
        messageDiv.textContent = content;
      }
      
      chat.appendChild(messageDiv);
      chat.scrollTop = chat.scrollHeight;
    }

    // Remove message from chat
    function removeMessage(id) {
      const messageDiv = document.getElementById(id);
      if (messageDiv) {
        messageDiv.remove();
      }
    }

    // Step 1: Create Session
    document.getElementById("createSession").onclick = async () => {
      const button = document.getElementById("createSession");
      const statusSpan = document.getElementById("sessionStatus");
      
      try {
        button.disabled = true;
        button.textContent = "Creating...";
        statusSpan.textContent = "Creating session...";
        
        const response = await fetch("/create_session", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || "Failed to create session");
        }
        
        const data = await response.json();
        sessionId = data.session_id;
        
        // Enable the upload products button
        document.getElementById("uploadProducts").disabled = false;
        
        // Update UI
        statusSpan.textContent = "Active";
        statusSpan.style.color = "#4CAF50";
        document.getElementById("sessionId").textContent = `Session ID: ${sessionId}`;
        document.getElementById("sessionId").classList.remove("hidden");
        
        // Move to next step
        currentStep = 2;
        updateSteps();
        
        addMessage("bot", "Session created successfully! Now you can upload your product catalog.");
      } catch (error) {
        console.error("Error creating session:", error);
        statusSpan.textContent = "Error creating session";
        statusSpan.style.color = "#f44336";
        addMessage("bot", "Error creating session: " + error.message);
      } finally {
        button.disabled = false;
        button.textContent = "Create New Session";
      }
    };

    // Step 2: Upload Products
    document.getElementById("uploadProducts").onclick = async () => {
      const user = JSON.parse(sessionStorage.getItem('user'));
      if (!user) {
        window.location.href = '/login';
        return;
      }
      
      const button = document.getElementById("uploadProducts");
      const statusDiv = document.getElementById("uploadStatus");
      const productsJson = document.getElementById("productsJson").value.trim();
      const imageFiles = document.getElementById("productImages").files;
      
      if (!productsJson) {
        statusDiv.textContent = "Please enter product data in JSON format";
        statusDiv.style.color = "#f44336";
        return;
      }
      
      try {
        // Validate JSON syntax before submission
        let products;
        try {
          products = JSON.parse(productsJson);
        } catch (jsonError) {
          // Provide detailed JSON error message
          const errorMessage = jsonError.message || "Invalid JSON format";
          const positionMatch = errorMessage.match(/position (\d+)/);
          let detailedError = `JSON Error: ${errorMessage}`;
          
          if (positionMatch) {
            const position = parseInt(positionMatch[1]);
            const lines = productsJson.substring(0, position).split('\n');
            const lineNumber = lines.length;
            const columnNumber = lines[lines.length - 1].length + 1;
            detailedError += ` at line ${lineNumber}, column ${columnNumber}`;
          }
          
          statusDiv.textContent = detailedError;
          statusDiv.style.color = "#f44336";
          return;
        }
        
        if (!Array.isArray(products)) {
          statusDiv.textContent = "Products must be an array of product objects";
          statusDiv.style.color = "#f44336";
          return;
        }
        
        if (products.length === 0) {
          statusDiv.textContent = "Please provide at least one product";
          statusDiv.style.color = "#f44336";
          return;
        }
        
        // Validate each product structure
        for (let i = 0; i < products.length; i++) {
          const product = products[i];
          if (typeof product !== 'object' || product === null) {
            statusDiv.textContent = `Product at index ${i} must be an object`;
            statusDiv.style.color = "#f44336";
            return;
          }
          
          if (!product.name) {
            statusDiv.textContent = `Product at index ${i} is missing required 'name' field`;
            statusDiv.style.color = "#f44336";
            return;
          }
          
          if (!product.product_id) {
            statusDiv.textContent = `Product at index ${i} is missing required 'product_id' field`;
            statusDiv.style.color = "#f44336";
            return;
          }
        }
        
        // Check image count matches product count
        if (imageFiles.length > 0 && imageFiles.length !== products.length) {
          statusDiv.textContent = `Number of images (${imageFiles.length}) must match number of products (${products.length})`;
          statusDiv.style.color = "#f44336";
          return;
        }
        
        // Add image_filename to each product if not present
        products.forEach((product, index) => {
          if (!product.image_filename && imageFiles[index]) {
            product.image_filename = imageFiles[index].name;
          }
        });
        
        button.disabled = true;
        button.textContent = "Uploading...";
        statusDiv.textContent = "Uploading products...";
        statusDiv.style.color = "#2196F3";
        
        // Create FormData
        const formData = new FormData();
        formData.append('products_json', JSON.stringify(products));
        
        // Add all image files with their original filenames
        for (let i = 0; i < imageFiles.length; i++) {
          formData.append('images', imageFiles[i], imageFiles[i].name);
        }
        
        console.log('Sending form data with', products.length, 'products and', imageFiles.length, 'images');
        
        // Send request
        const response = await fetch(`/upload_products/${sessionId}`, {
          method: "POST",
          body: formData
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Server responded with status ${response.status}`);
        }
        
        const data = await response.json();
        
        const successMessage = `Successfully processed ${data.products_processed || data.processed_products || 'all'} products.`;
        addMessage("bot", successMessage);
        
        statusDiv.textContent = successMessage;
        statusDiv.style.color = "#4CAF50";
        
        // Move to next step
        currentStep = 3;
        updateSteps();
        
        addMessage("bot", "You can now search for products by uploading an image or asking questions.");
        
      } catch (error) {
        console.error("Error uploading products:", error);
        statusDiv.textContent = `Error: ${error.message}`;
        statusDiv.style.color = "#f44336";
      } finally {
        button.disabled = false;
        button.textContent = "Upload Products";
      }
    };

    // Step 3: Image Upload
    const browseBtn = document.getElementById("browseImage");
    const imageInput = document.getElementById("imageQuery");
    const selectedImageSpan = document.getElementById("selectedImage");
    
    if (browseBtn && imageInput) {
      browseBtn.onclick = () => imageInput.click();
      
      imageInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file && selectedImageSpan) {
          selectedImageSpan.textContent = file.name;
        }
      };
    }

    // Handle text queries
    const sendQueryBtn = document.getElementById("sendQuery");
    const textQueryInput = document.getElementById("textQuery");
    const fileInput = document.getElementById("imageQuery");
    
    if (sendQueryBtn && textQueryInput && fileInput) {
      sendQueryBtn.onclick = async () => {
        const query = textQueryInput.value.trim();
        const file = fileInput.files[0];
        
        if (!query && !file) {
          addMessage("bot", "Please enter a question or upload an image to search.");
          return;
        }
        
        // Priority: If both text and image are provided, use image search only
        if (file) {
          addMessage("user", query ? `${query} [Image: ${file.name}]` : `[Image: ${file.name}]`);
          
          const formData = new FormData();
          formData.append("file", file);
          
          try {
            const response = await fetch(`/query_image/${sessionId}`, {
              method: "POST",
              body: formData
            });
            
            let data;
            try {
              data = await response.json();
            } catch (parseError) {
              throw new Error("Server returned invalid response format. Please check your connection.");
            }
            
            if (response.ok) {
              // Display the message from the server
              if (data.message) {
                addMessage("bot", data.message);
              }
              
              // Display results if available
              if (data.results && Array.isArray(data.results) && data.results.length > 0) {
                data.results.forEach(product => {
                  const scoreText = product.score ? `${Math.round(product.score)}` : '';
                  addMessage("bot", {
                    name: product.name || 'Unnamed Product',
                    price: product.price || '',
                    category: product.category || '',
                    description: product.description || '',
                    image_url: product.image_url || '',
                    score: scoreText
                  }, true);
                });
              } else if (!data.message) {
                addMessage("bot", "No similar products found.");
              }
            } else {
              addMessage(`Error: ${data.error || 'Failed to process image'}`, 'error');
            }
          } catch (error) {
            console.error('Error searching by image:', error);
            if (error.message && error.message.includes("Unexpected token")) {
              addMessage("bot", "Error: Server returned invalid response. Please check your connection and try again.");
            } else {
              addMessage('An error occurred while searching for similar products. Please try again.', 'error');
            }
          }
          
          // Clear the file input
          fileInput.value = "";
          const selectedImageSpan = document.getElementById("selectedImage");
          if (selectedImageSpan) {
            selectedImageSpan.textContent = "No image selected";
          }
          
          // Clear text query if it was used with image
          if (query) {
            textQueryInput.value = "";
          }
        } else if (query) {
          // Text-only search
          addMessage("user", query);
          textQueryInput.value = "";
          
          try {
            const response = await fetch(`/query`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                query, 
                session_id: sessionId 
              })
            });
            
            let data;
            try {
              data = await response.json();
            } catch (parseError) {
              throw new Error("Server returned invalid response format. Please check your connection.");
            }
            
            if (response.ok) {
              // Display the message from the server
              if (data.message) {
                addMessage("bot", data.message);
              }
              
              // Display results if available
              if (data.results && Array.isArray(data.results) && data.results.length > 0) {
                data.results.forEach(product => {
                  const scoreText = product.score ? `${Math.round(product.score)}` : '';
                  addMessage("bot", {
                    name: product.name || 'Unnamed Product',
                    price: product.price || '',
                    category: product.category || '',
                    description: product.description || '',
                    image_url: product.image_url || '',
                    score: scoreText
                  }, true);
                });
              } else if (!data.message) {
                addMessage("bot", "No matching products found.");
              }
            } else {
              throw new Error(data.error || "Failed to process your query");
            }
          } catch (error) {
            console.error("Error processing query:", error);
            if (error.message && error.message.includes("Unexpected token")) {
              addMessage("bot", "Error: Server returned invalid response. Please check your connection and try again.");
            } else {
              addMessage("bot", "Error: " + (error.message || "Failed to process your query"));
            }
          }
        }
      };
    }

    // Allow pressing Enter in the query input
    if (textQueryInput && sendQueryBtn) {
      textQueryInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          sendQueryBtn.click();
        }
      });
    }

    // Check authentication status when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/check_session');
        const data = await response.json();
        
        if (!response.ok || !data.authenticated) {
          // If not authenticated, redirect to login
          window.location.href = '/login';
          return;
        }
        
        // Store user data in sessionStorage if not already present
        if (data.user && !sessionStorage.getItem('user')) {
          sessionStorage.setItem('user', JSON.stringify(data.user));
        }
        
        // Initialize your app here
        initializeApp();
        
      } catch (error) {
        console.error('Session check failed:', error);
        window.location.href = '/login';
      }
    });
    
    function initializeApp() {
      const user = JSON.parse(sessionStorage.getItem('user'));
      if (!user) {
        window.location.href = '/login';
        return;
      }
      
      // Show user info
      document.getElementById('userInfo').style.display = 'block';
      document.getElementById('userName').textContent = user.name;
      
      // Initialize the UI
      updateSteps();
    }

    // Logout function
    async function logout() {
      try {
        await fetch('/logout', { method: 'POST' });
        sessionStorage.removeItem('user');
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout failed:', error);
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI E-commerce Chatbot</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 800px; margin: 0 auto; }
    .step { 
      border: 1px solid #ddd; 
      padding: 15px; 
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .step-header { 
      font-weight: bold; 
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .step-content { display: none; }
    .step.active .step-content { display: block; }
    .step.complete { border-color: #4CAF50; }
    .step-number {
      background: #4CAF50;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }
    #chat { 
      border: 1px solid #ccc; 
      padding: 15px; 
      height: 400px; 
      overflow-y: auto; 
      margin: 20px 0;
    }
    .message { margin: 10px 0; padding: 8px 12px; border-radius: 5px; max-width: 80%; }
    .user { 
      background-color: #e3f2fd; 
      margin-left: auto; 
      margin-right: 0;
      text-align: right;
    }
    .bot { 
      background-color: #f1f1f1; 
      margin-right: auto;
    }
    .product { 
      border: 1px solid #ddd; 
      margin: 5px; 
      padding: 10px; 
      display: inline-block; 
      width: 180px; 
      text-align: center; 
      vertical-align: top;
      border-radius: 5px;
    }
    .product img { 
      width: 150px; 
      height: 150px; 
      object-fit: cover;
      border-radius: 4px;
    }
    .product-title {
      font-weight: bold;
      margin: 5px 0;
    }
    .product-price {
      color: #e53935;
      font-weight: bold;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    textarea, input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>AI E-commerce Assistant</h1>
  
  <!-- Step 1: Create Session -->
  <div class="step" id="step1">
    <div class="step-header">
      <div><span class="step-number">1</span> Start a New Session</div>
      <span id="sessionStatus">Not started</span>
    </div>
    <div class="step-content">
      <p>Click the button below to start a new shopping session.</p>
      <button id="createSession">Create New Session</button>
      <div id="sessionId" class="hidden"></div>
    </div>
  </div>

  <!-- Step 2: Upload Products -->
  <div class="step" id="step2">
    <div class="step-header">
      <div><span class="step-number">2</span> Upload Product Catalog</div>
    </div>
    <div class="step-content">
      <p>Upload your product catalog in JSON format:</p>
      <textarea id="productsJson" rows="6" placeholder='[
  {
    "product_id": "1",
    "name": "Gold Necklace",
    "category": "Jewelry",
    "price": "499.99",
    "description": "Elegant gold necklace with 18K gold."
  },
  {
    "product_id": "2",
    "name": "Silver Ring",
    "category": "Jewelry",
    "price": "199.99",
    "description": "Beautiful sterling silver ring with cubic zirconia."
  }
]'></textarea>
      <p>Upload product images (make sure the order matches the JSON):</p>
      <input type="file" id="productImages" multiple accept="image/*">
      <button id="uploadProducts" disabled>Upload Products</button>
      <div id="uploadStatus"></div>
    </div>
  </div>

  <!-- Step 3: Search and Chat -->
  <div class="step" id="step3">
    <div class="step-header">
      <div><span class="step-number">3</span> Search & Ask Questions</div>
    </div>
    <div class="step-content">
      <div id="chat"></div>
      <div>
        <input type="file" id="imageQuery" accept="image/*" style="display: none;">
        <button id="browseImage">Upload Image to Search</button>
        <span id="selectedImage">No image selected</span>
      </div>
      <div style="display: flex; margin-top: 10px;">
        <input type="text" id="textQuery" placeholder="Ask a question about the products..." style="flex-grow: 1;">
        <button id="sendQuery">Send</button>
      </div>
    </div>
  </div>

  <script>
    let sessionId = "";
    let currentStep = 1;

    // Initialize steps
    function updateSteps() {
      document.querySelectorAll('.step').forEach((step, index) => {
        if (index + 1 < currentStep) {
          step.classList.add('complete');
          step.classList.remove('active');
        } else if (index + 1 === currentStep) {
          step.classList.add('active');
          step.classList.remove('complete');
        } else {
          step.classList.remove('active', 'complete');
        }
      });
    }

    // Format price
    function formatPrice(price) {
      if (!price) return '';
      return `$${parseFloat(price).toFixed(2)}`;
    }

    // Add message to chat
    function addMessage(sender, content, isProduct = false) {
      const chatDiv = document.getElementById("chat");
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}`;
      
      if (isProduct) {
        messageDiv.innerHTML = `
          <div class="product">
            <img src="${content.url}" alt="${content.name || 'Product'}">
            <div class="product-title">${content.name || 'Product'}</div>
            <div class="product-price">${formatPrice(content.price)}</div>
            <div class="product-category">${content.category || ''}</div>
          </div>
        `;
      } else {
        messageDiv.textContent = content;
      }
      
      chatDiv.appendChild(messageDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Step 1: Create Session
    document.getElementById("createSession").onclick = async () => {
      const button = document.getElementById("createSession");
      const statusSpan = document.getElementById("sessionStatus");
      
      try {
        button.disabled = true;
        button.textContent = "Creating...";
        statusSpan.textContent = "Creating session...";
        
        const response = await fetch("/create_session", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || "Failed to create session");
        }
        
        const data = await response.json();
        sessionId = data.session_id;
        
        // Enable the upload products button
        document.getElementById("uploadProducts").disabled = false;
        
        // Update UI
        statusSpan.textContent = "Active";
        statusSpan.style.color = "#4CAF50";
        document.getElementById("sessionId").textContent = `Session ID: ${sessionId}`;
        document.getElementById("sessionId").classList.remove("hidden");
        
        // Move to next step
        currentStep = 2;
        updateSteps();
        
        addMessage("bot", "Session created successfully! Now you can upload your product catalog.");
      } catch (error) {
        console.error("Error creating session:", error);
        statusSpan.textContent = "Error creating session";
        statusSpan.style.color = "#f44336";
        addMessage("bot", "Error creating session: " + error.message);
      } finally {
        button.disabled = false;
        button.textContent = "Create New Session";
      }
    };

    // Step 2: Upload Products
    document.getElementById("uploadProducts").onclick = async () => {
      const button = document.getElementById("uploadProducts");
      const statusDiv = document.getElementById("uploadStatus");
      
      if (!sessionId) {
        addMessage("bot", "Please create a session first.");
        return;
      }

      const productsJson = document.getElementById("productsJson").value.trim();
      if (!productsJson) {
        addMessage("bot", "Please enter product details in JSON format.");
        return;
      }

      // Validate JSON format and check for image_urls
      let products;
      try {
        products = JSON.parse(productsJson);
        // Check if products is an array
        if (!Array.isArray(products)) {
          throw new Error("Products data should be an array of product objects");
        }
      } catch (e) {
        addMessage("bot", "Invalid JSON format. Please check your product data.");
        console.error("JSON parse error:", e);
        return;
      }

      const files = document.getElementById("productImages").files;
      const hasImageUrls = products.some(product => product.image_url);
      
      if (files.length === 0 && !hasImageUrls) {
        addMessage("bot", "Please either upload product images or include image_url in your product data.");
        return;
      }

      // Disable button and show loading state
      button.disabled = true;
      button.textContent = "Uploading...";
      statusDiv.textContent = "Uploading products, please wait...";
      statusDiv.style.color = "#2196F3";

      try {
        const formData = new FormData();
        formData.append("products_json", productsJson);
        
        // Only append files if they were uploaded
        for (let i = 0; i < files.length; i++) {
          formData.append("images", files[i]);
        }

        console.log("Sending upload request...");
        const response = await fetch(`/upload_products/${sessionId}`, {
          method: "POST",
          body: formData,
        });
        
        console.log("Response status:", response.status);
        const responseText = await response.text();
        console.log("Response text:", responseText);
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          console.error("Failed to parse response as JSON:", e);
          throw new Error("Invalid response from server");
        }
        
        if (response.ok) {
          addMessage("bot", `Successfully processed ${data.processed_products || 0} products.`);
          statusDiv.textContent = `Successfully processed ${data.processed_products} products.`;
          statusDiv.style.color = "#4CAF50";
          
          // Move to next step
          currentStep = 3;
          updateSteps();
          
          addMessage("bot", "You can now search for products by uploading an image or asking questions.");
        } else {
          throw new Error(data.error || `Server responded with status ${response.status}`);
        }
      } catch (error) {
        console.error("Error uploading products:", error);
        const errorMessage = error.message || "Unknown error occurred";
        addMessage("bot", "Error uploading products: " + errorMessage);
        statusDiv.textContent = "Error: " + errorMessage;
        statusDiv.style.color = "#f44336";
      } finally {
        // Re-enable button
        button.disabled = false;
        button.textContent = "Upload Products";
      }
    };

    // Step 3: Image Upload
    document.getElementById("browseImage").onclick = () => {
      document.getElementById("imageQuery").click();
    };

    document.getElementById("imageQuery").onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        document.getElementById("selectedImage").textContent = file.name;
      }
    };

    // Handle text queries
    document.getElementById("sendQuery").onclick = async () => {
      const query = document.getElementById("textQuery").value.trim();
      const fileInput = document.getElementById("imageQuery");
      const file = fileInput.files[0];
      
      if (!query && !file) {
        addMessage("bot", "Please enter a question or upload an image to search.");
        return;
      }
      
      if (query) {
        addMessage("user", query);
        document.getElementById("textQuery").value = "";
        
        try {
          const response = await fetch("/query_text", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              query, 
              session_id: sessionId 
            })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            if (data.answer) {
              addMessage("bot", data.answer);
            }
            
            if (data.images && data.images.length > 0) {
              data.images.forEach(img => {
                addMessage("bot", {
                  name: img.description,
                  price: img.price,
                  category: img.category,
                  url: img.url
                }, true);
              });
            } else if (!data.answer) {
              addMessage("bot", "No matching products found.");
            }
          } else {
            throw new Error(data.error || "Failed to process your query");
          }
        } catch (error) {
          console.error("Error processing query:", error);
          addMessage("bot", "Error: " + (error.message || "Failed to process your query"));
        }
      }
      
      if (file) {
        addMessage("user", "[Image: " + file.name + "]");
        
        const formData = new FormData();
        formData.append("file", file);
        
        try {
          const response = await fetch(`/query_image/${sessionId}`, {
            method: "POST",
            body: formData
          });
          
          const data = await response.json();
          
          if (response.ok) {
            if (data.answer) {
              addMessage("bot", data.answer);
            }
            
            if (data.images && data.images.length > 0) {
              data.images.forEach(img => {
                addMessage("bot", {
                  name: img.description,
                  price: img.price,
                  category: img.category,
                  url: img.url
                }, true);
              });
            } else if (!data.answer) {
              addMessage("bot", "No similar products found.");
            }
            
            // Clear the file input
            fileInput.value = "";
            document.getElementById("selectedImage").textContent = "No image selected";
          } else {
            throw new Error(data.error || "Failed to process image");
          }
        } catch (error) {
          console.error("Error processing image:", error);
          addMessage("bot", "Error: " + (error.message || "Failed to process image"));
        }
      }
    };

    // Allow pressing Enter in the query input
    document.getElementById("textQuery").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        document.getElementById("sendQuery").click();
      }
    });

    // Initialize the UI
    updateSteps();
  </script>
</body>
</html>
